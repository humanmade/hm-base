machine:
  php:
    version: 7.0.4

checkout:
  post:
    - git submodule sync
    - git submodule foreach git prune
    - git submodule foreach git fetch --all
    - git submodule foreach git fetch --tags
    - git submodule update --init --recursive || (rm -fr .git/config .git/modules && git submodule deinit -f . && git submodule update --init --recursive)

dependencies:
  post:
    - npm install -g casperjs
    - yes '' | pecl install memcached-stable

test:
  pre:
    - find -L ./ -name '*.php' -print0 | xargs -0 -n 1 -P 4 php -l > /dev/null
    - mysql -e 'create database wp_tests;'
  override:
    - phpunit
    - php -S 127.0.0.1:8080:
        background: true
    - sleep 5
    - cp .tests/wp-casperjs-tests-config.php wp-config-local.php
    - casperjs test .tests/casperjs --url=http://localhost:8080 --log-level=debug
